apiVersion: kubeflow.org/v1
kind: PyTorchJob
metadata:
  name: test-ue-worlddatapipeline
spec:
  runPolicy:
    schedulingPolicy:
      priorityClass: normal
      queue: default
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      restartPolicy: Never
      template:
        spec:
          imagePullSecrets:
            - name: vast-secret
          schedulerName: volcano
          priorityClassName: normal

          containers:
            - name: pytorch
              image: ccr-23gxup9u-vpc.cnc.bj.baidubce.com/model/worlddatapipeline:v1
              imagePullPolicy: Always
              securityContext:
                capabilities:
                  add: ["IPC_LOCK"]
              resources:
                requests:
                  cpu: "2"
                  memory: "4Gi"
                limits:
                  cpu: "4"
                  memory: "8Gi"

              env:
                - name: TZ
                  value: Asia/Shanghai
                - name: UE_SYSTEM_TYPE
                  value: linux
                - name: UE_CONFIG_PATH
                  value: /app/ue_pipeline/config/linux_ue_config.json

              command:
                - /bin/sh
                - -c
                - |
                  set -eu

                  echo "=== BEGIN ==="
                  echo "=== env ==="
                  echo "PATH=$PATH"

                  echo "=== python ==="
                  command -v python || true
                  python -V || true

                  echo "=== ue binary check ==="
                  UE_BIN=/usr/local/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd
                  echo "UE_BIN=$UE_BIN"
                  echo "CHECK_UE_BIN_EXIST"
                  if [ ! -e "$UE_BIN" ]; then
                    echo "UE_BIN_NOT_FOUND"
                    ls -la /usr/local/UnrealEngine || true
                    ls -la /usr/local/UnrealEngine/Engine || true
                    ls -la /usr/local/UnrealEngine/Engine/Binaries || true
                    ls -la /usr/local/UnrealEngine/Engine/Binaries/Linux || true
                    exit 11
                  fi
                  echo "CHECK_UE_BIN_LS"
                  ls -la "$UE_BIN"
                  echo "CHECK_UE_BIN_LS_DONE"
                  echo "=== run UnrealEditor-Cmd -help ==="
                  # If UE cannot start, this will fail with a clear message in logs.
                  "$UE_BIN" -help > /tmp/ue_help.txt 2>&1 || (echo "UE_FAILED"; cat /tmp/ue_help.txt; exit 12)
                  echo "=== UnrealEditor-Cmd -help (first 80 lines) ==="
                  sed -n '1,80p' /tmp/ue_help.txt
                  echo "UE_OK"

                  echo "=== ldd (diagnose missing libs, timeout 30s) ==="
                  if command -v ldd >/dev/null 2>&1; then
                    if command -v timeout >/dev/null 2>&1; then
                      timeout 30s ldd "$UE_BIN" | sed -n '1,200p' || true
                    else
                      ldd "$UE_BIN" | sed -n '1,200p' || true
                    fi
                  fi
                  echo "LDD_DONE"

                  echo "=== app help ==="
                  python /app/app.py --help
                  echo "APP_OK"
                  echo "ALL_OK"

              volumeMounts:
                # 只挂载允许的子目录，不挂 /mnt/pfs 根目录
                - name: ue-engine
                  mountPath: /usr/local/UnrealEngine
                  readOnly: true
                - name: devshm
                  mountPath: /dev/shm

          volumes:
            - name: ue-engine
              hostPath:
                path: /mnt/pfs/users/wuyibo/UE5.7
                type: Directory
            - name: devshm
              emptyDir:
                medium: Memory
