---
# ConfigMap for NavMesh baking configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: bake-config
data:
  # Unreal Engine paths
  UE_ENGINE_PATH: "/usr/local/UnrealEngine"
  UE_EDITOR_PATH: "/usr/local/UnrealEngine/Engine/Binaries/Linux/UnrealEditor-Cmd"
  
  # Project paths
  PROJECT_PATH: "/app/ue_template/project/WorldData.uproject"
  OUTPUT_BASE_DIR: "/app/output"
  
  # Map to bake NavMesh
  MAP_PATH: "/Game/SecretBase/Map/SecretBase"
  MAP_NAME: "SecretBase"
  
  # Scene configuration
  SCENE_NAME: "SecretBase"

---
apiVersion: kubeflow.org/v1
kind: PyTorchJob
metadata:
  name: bake-worlddatapipeline
spec:
  runPolicy:
    schedulingPolicy:
      priorityClass: normal
      queue: default
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      restartPolicy: Never
      template:
        spec:
          securityContext:
            runAsUser: 2007
            runAsGroup: 2007
            fsGroup: 2007
          imagePullSecrets:
            - name: vast-secret
          schedulerName: volcano
          priorityClassName: normal

          containers:
            - name: pytorch
              image: ccr-23gxup9u-vpc.cnc.bj.baidubce.com/model/worlddatapipeline:v1
              imagePullPolicy: Always
              securityContext:
                capabilities:
                  add: ["IPC_LOCK"]
                allowPrivilegeEscalation: false
              resources:
                requests:
                  cpu: "4"
                  memory: "8Gi"
                limits:
                  cpu: "8"
                  memory: "16Gi"

              envFrom:
                - configMapRef:
                    name: bake-config
              
              env:
                - name: TZ
                  value: Asia/Shanghai
                - name: UE_SYSTEM_TYPE
                  value: linux
                - name: UE_CONFIG_PATH
                  value: /tmp/runtime_ue_config.json

              command:
                - /bin/bash
                - -c
                - |
                  set -eu

                  echo "=== BEGIN NAVMESH BAKE JOB ==="
                  
                  echo "=== Configuration from ConfigMap ==="
                  echo "UE_ENGINE_PATH: $UE_ENGINE_PATH"
                  echo "UE_EDITOR_PATH: $UE_EDITOR_PATH"
                  echo "PROJECT_PATH: $PROJECT_PATH"
                  echo "MAP_PATH: $MAP_PATH"
                  echo "MAP_NAME: $MAP_NAME"
                  echo "SCENE_NAME: $SCENE_NAME"
                  
                  echo "=== Execute dev-linux.sh ==="
                  if [ -f /app/dev-linux.sh ]; then
                    source /app/dev-linux.sh
                    echo "dev-linux.sh executed successfully"
                  else
                    echo "WARNING: dev-linux.sh not found"
                  fi
                  
                  echo "=== Environment Info ==="
                  echo "User: $(whoami)"
                  echo "UE_SYSTEM_TYPE: $UE_SYSTEM_TYPE"
                  echo "Working Directory: $(pwd)"
                  
                  echo "=== SDL Configuration (headless mode) ==="
                  export SDL_VIDEODRIVER=dummy
                  export SDL_AUDIODRIVER=dummy
                  export XDG_RUNTIME_DIR=/tmp/xdg-runtime
                  mkdir -p "$XDG_RUNTIME_DIR" || true
                  chmod 700 "$XDG_RUNTIME_DIR" || true
                  export DISPLAY=
                  export WAYLAND_DISPLAY=

                  echo "=== Update UE config with ConfigMap paths ==="
                  cat > /tmp/runtime_ue_config.json <<EOF
                  {
                    "editor_path": "${UE_EDITOR_PATH}",
                    "project_path": "${PROJECT_PATH}",
                    "output_base_dir": "${OUTPUT_BASE_DIR}",
                    "exclude_map_names": ["Overview"],
                    "scenes": {
                      "${SCENE_NAME}": {
                        "maps": [
                          {
                            "name": "${MAP_NAME}",
                            "path": "${MAP_PATH}",
                            "low_mesh": false
                          }
                        ]
                      }
                    }
                  }
                  EOF
                  
                  echo "Runtime UE config:"
                  cat "$UE_CONFIG_PATH"

                  echo "=== Run NavMesh bake command ==="
                  cd /app
                  python -m ue_pipeline.run_bake_navmesh \
                    --scene "${SCENE_NAME}" \
                    --map "${MAP_NAME}"
                  
                  EXIT_CODE=$?
                  if [ $EXIT_CODE -eq 0 ]; then
                    echo "=== NAVMESH BAKE SUCCESS ==="
                  else
                    echo "=== NAVMESH BAKE FAILED (exit code: $EXIT_CODE) ==="
                    exit $EXIT_CODE
                  fi

                  echo "=== Check results ==="
                  ls -la /app/ue_template/project/Saved/Cooked/ || true
                  
                  echo "JOB_COMPLETE"
                  echo "ALL_OK"

              volumeMounts:
                - name: ue-engine
                  mountPath: /usr/local/UnrealEngine
                  readOnly: true
                - name: devshm
                  mountPath: /dev/shm

          volumes:
            - name: ue-engine
              hostPath:
                path: /mnt/pfs/users/wuyibo/UE5.7
                type: Directory
            - name: devshm
              emptyDir:
                medium: Memory
---
# 使用说明:
# 1. 修改 ConfigMap 中的参数来配置烘焙任务
# 2. 切换地图: 修改 MAP_PATH, MAP_NAME, SCENE_NAME
# 3. 应用配置: kubectl apply -f job-bake.yaml
