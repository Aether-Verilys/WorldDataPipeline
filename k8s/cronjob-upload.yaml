apiVersion: batch/v1
kind: CronJob
metadata:
  name: ue-upload-scenes-daily
  labels:
    app: ue-pipeline
    task: upload-scenes
spec:
  # 每天凌晨 3 点执行
  schedule: "0 3 * * *"
  # 保留最近 3 次任务历史
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  # 并发策略：禁止并发执行
  concurrencyPolicy: Forbid
  
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 7200  # 2小时
      template:
        metadata:
          labels:
            app: ue-pipeline
            task: upload-scenes
        spec:
          restartPolicy: OnFailure
          containers:
          - name: ue-pipeline
            image: your-registry/ue-pipeline:latest
            
            command: ["python3", "app.py"]
            args: 
              - "upload_scenes"
            
            workingDir: /app/ue_pipeline
            
            env:
            - name: UE_SYSTEM_TYPE
              value: "linux"
            # BOS 认证信息（从 Secret 读取）
            - name: BOS_AK
              valueFrom:
                secretKeyRef:
                  name: bos-credentials
                  key: access-key
            - name: BOS_SK
              valueFrom:
                secretKeyRef:
                  name: bos-credentials
                  key: secret-key
            
            resources:
              requests:
                memory: "4Gi"
                cpu: "2"
              limits:
                memory: "8Gi"
                cpu: "4"
            
            volumeMounts:
            - name: ue-config
              mountPath: /app/ue_pipeline/config
              readOnly: true
            - name: output
              mountPath: /app/output
              readOnly: true
          
          volumes:
          - name: ue-config
            configMap:
              name: ue-config
          - name: output
            persistentVolumeClaim:
              claimName: ue-output-pvc
