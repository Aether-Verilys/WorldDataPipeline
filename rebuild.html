<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>第一人称相机复现（UE -> Three.js）</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; color: #eee; font-family: -apple-system, Roboto, "Segoe UI", "Helvetica", Arial; }
        #ui-container {
            position: absolute; left: 10px; top: 10px; z-index: 20;
            background: rgba(0,0,0,0.55); padding: 12px; border-radius: 8px; width: 280px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }
        #ui-container h3 { margin: 0 0 8px 0; font-size: 16px; }
        .row { margin-top: 8px; }
        button { cursor: pointer; padding: 6px 10px; margin-right: 6px; background:#222; color:#fff; border:1px solid #333; border-radius:4px; }
        input[type="file"] { color: #ddd; }
        #status { font-size: 12px; color: #bbb; margin-top: 6px; }
        #frameInfo { font-size: 13px; margin-top: 6px; color:#9fd; }
        #log { position: absolute; right: 10px; top: 10px; z-index: 20; width: 420px; max-height: 50vh; overflow:auto; font-family: monospace; font-size:12px; background: rgba(0,0,0,0.55); padding:8px; border-radius:8px; color:#ddd; }
    </style>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="ui-container">
        <h3>相机轨迹复现</h3>
        <div class="row">
            <input id="csvFile" type="file" accept=".csv" />
        </div>
        <div class="row">
            <button id="playBtn">播放</button>
            <button id="pauseBtn">暂停</button>
            <button id="stepBtn">单步</button>
        </div>
        <div id="status">等待加载 CSV ...</div>
        <div id="frameInfo">Frame: -</div>
    </div>

    <pre id="log"></pre>

<script>
/* =========================
   Config
   ========================= */
const cameraConfig = {
    fps: 30,
    width: 1920,
    height: 1080,
    fov: 90,
    isHorizontalFov: true
};

/* 计算垂直 FOV */
const aspectRatio = cameraConfig.width / cameraConfig.height;
let verticalFov = cameraConfig.fov;
if (cameraConfig.isHorizontalFov) {
    const hFovRad = cameraConfig.fov * (Math.PI / 180);
    const vFovRad = 2 * Math.atan(Math.tan(hFovRad / 2) / aspectRatio);
    verticalFov = vFovRad * (180 / Math.PI);
    console.log(`FOV 转换: H ${cameraConfig.fov}° -> V ${verticalFov.toFixed(3)}°`);
}

/* =========================
   Three.js 初始化
   ========================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0b0b);
scene.fog = new THREE.Fog(0x0b0b0b, 10, 400);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(verticalFov, window.innerWidth / window.innerHeight, 0.01, 2000);
camera.position.set(0, 1.6, 5);
camera.lookAt(0,1.6,0);

/* 场景参考物 */
const grid = new THREE.GridHelper(500, 50, 0x303030, 0x202020);
scene.add(grid);
const axes = new THREE.AxesHelper(3);
scene.add(axes);
const boxGeo = new THREE.BoxGeometry(2,2,2);
const boxMat = new THREE.MeshNormalMaterial();
for (let i=0;i<200;i++){
    const m = new THREE.Mesh(boxGeo, boxMat);
    m.position.set((Math.random()-0.5)*200, Math.random()*20, (Math.random()-0.5)*200);
    scene.add(m);
}

/* =========================
   全局变量
   ========================= */
let framesData = [];
let isPlaying = false;
let currentFrameIndex = 0;
const clock = new THREE.Clock();
const targetFPS = cameraConfig.fps;
const frameInterval = 1 / targetFPS;
let timeAccumulator = 0;

const statusEl = document.getElementById('status');
const frameInfoEl = document.getElementById('frameInfo');
const logEl = document.getElementById('log');

// 日志函数
function log(...args){ 
    console.log(...args); 
    logEl.textContent = logEl.textContent + args.join(' ') + '\n'; 
    logEl.scrollTop = logEl.scrollHeight; 
}

/* =========================
   坐标变换矩阵
   ========================= */
const C_mat = new THREE.Matrix4().set(
    0, 1, 0, 0,
    0, 0, 1, 0,
   -1, 0, 0, 0,
    0, 0, 0, 1
);
const C_inv = new THREE.Matrix4().copy(C_mat).invert();

/* =========================
   CSV 解析
   ========================= */
function rowToArrayMatrix(row){
    const keys = ['m00','m01','m02','m03','m10','m11','m12','m13','m20','m21','m22','m23','m30','m31','m32','m33'];
    const arr = [];
    for (let k of keys){
        let v = row[k];
        if (v === undefined) {
            v = row[k.toUpperCase()] ?? row[k.replace(/\s+/g,'')];
            if (v === undefined) {
                for (const header in row) {
                    const normalized = header.toString().toLowerCase().replace(/[^a-z0-9]/g,'');
                    if (normalized === k) { v = row[header]; break; }
                }
            }
        }
        arr.push(Number(v || 0));
    }
    return arr;
}

/* =========================
   应用相机数据
   ========================= */
function applyRowToCamera(row, showDetails = false) {
    const displayFrame = row.frame ?? row.Frame ?? row['FrameID'] ?? row['frame_id'] ?? 'n/a';
    frameInfoEl.innerText = `Frame: ${displayFrame}`;

    if (!Object.keys(row).some(k => k.toLowerCase().startsWith('m0') || k.toLowerCase().startsWith('m1') || k.toLowerCase().startsWith('m2') || k.toLowerCase().startsWith('m3'))) {
        if (showDetails) log('此行未找到 m00..m33 字段，跳过。');
        return;
    }

    // 1) 读取矩阵
    const flat = rowToArrayMatrix(row);

    // 2) 构建外参矩阵（行主序）
    const matExtrinsic = new THREE.Matrix4();
    matExtrinsic.set(
        flat[0], flat[1], flat[2], flat[3],
        flat[4], flat[5], flat[6], flat[7],
        flat[8], flat[9], flat[10], flat[11],
        flat[12], flat[13], flat[14], flat[15]
    );

    // 3) 求逆得到世界矩阵（UE坐标系）
    const matWorldUE = new THREE.Matrix4().copy(matExtrinsic).invert();
    
    // 4) 坐标系转换: UE -> Three.js
    const matWorldThree = new THREE.Matrix4();
    matWorldThree.multiplyMatrices(C_mat, matWorldUE).multiply(C_inv);

    // 5) 分解位置和旋转
    const pos = new THREE.Vector3(), quat = new THREE.Quaternion(), scl = new THREE.Vector3();
    matWorldThree.decompose(pos, quat, scl);

    // 6) 单位转换: cm -> m
    const unitScale = 0.01;
    pos.multiplyScalar(unitScale);

    // 7) 应用到相机
    camera.position.copy(pos);
    camera.quaternion.copy(quat);

    // 8) 详细日志（仅单步时）
    if (showDetails) {
        const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(quat);
        const up = new THREE.Vector3(0, 1, 0).applyQuaternion(quat);
        const right = new THREE.Vector3(1, 0, 0).applyQuaternion(quat);

        log(`=== Frame ${displayFrame} ===`);
        log(`Position (m): ${pos.toArray().map(x=>x.toFixed(3)).join(', ')}`);
        log(`Quaternion: ${quat.toArray().map(x=>x.toFixed(4)).join(', ')}`);
        log(`Forward (OpenGL -Z): ${forward.toArray().map(x=>x.toFixed(4)).join(', ')}`);
        log(`Up (OpenGL +Y): ${up.toArray().map(x=>x.toFixed(4)).join(', ')}`);
        log(`Right (OpenGL +X): ${right.toArray().map(x=>x.toFixed(4)).join(', ')}`);
        log('');
    }
}

/* =========================
   播放控制
   ========================= */
function updateCameraByIndex(index, showDetails = false) {
    if (index < 0 || index >= framesData.length) return;
    const row = framesData[index];
    applyRowToCamera(row, showDetails);
}

function startPlayback() {
    if (!framesData || framesData.length === 0) { 
        alert('请先加载 CSV 文件'); 
        return; 
    }
    currentFrameIndex = 0;
    isPlaying = true;
    timeAccumulator = 0;
    log(`播放开始，共 ${framesData.length} 帧 @ ${targetFPS} fps`);
}

function pausePlayback() {
    isPlaying = false;
    log(`播放暂停于第 ${currentFrameIndex} 帧`);
}

function stepOnce() {
    if (!framesData || framesData.length === 0) return;
    // 单步显示详细日志
    updateCameraByIndex(currentFrameIndex, true); 
    currentFrameIndex = Math.min(currentFrameIndex + 1, framesData.length - 1);
}

/* =========================
   动画循环
   ========================= */
function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    
    if (isPlaying) {
        timeAccumulator += delta;
        
        while (timeAccumulator >= frameInterval) {
            updateCameraByIndex(currentFrameIndex, false);
            currentFrameIndex++;
            timeAccumulator -= frameInterval;
            
            if (currentFrameIndex >= framesData.length) {
                isPlaying = false;
                log('播放结束');
                break;
            }
        }
    }

    renderer.render(scene, camera);
}
animate();

/* =========================
   UI 控件绑定
   ========================= */
document.getElementById('playBtn').addEventListener('click', startPlayback);
document.getElementById('pauseBtn').addEventListener('click', pausePlayback);
document.getElementById('stepBtn').addEventListener('click', stepOnce);

document.getElementById('csvFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    if (!file) return;
    
    log('正在加载 CSV...');
    
    Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        worker: true,
        complete: function(results){
            framesData = results.data;
            statusEl.innerText = `已加载 ${framesData.length} 帧`;
            log(`CSV 加载完成，共 ${framesData.length} 帧`);
            
            // 应用首帧并显示详细信息
            if (framesData.length > 0) {
                currentFrameIndex = 0;
                log('=== 首帧数据 ===');
                applyRowToCamera(framesData[0], true);
            }
        },
        error: function(err){
            log('CSV 解析错误：', err);
            statusEl.innerText = 'CSV 解析错误';
        }
    });
});

/* =========================
   窗口自适应
   ========================= */
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
